# 数据同步功能测试计划

## 测试日期：2025-10-09

## 测试版本：v1.8.0 + 同步锁优化

---

## 一、测试目标

验证数据同步机制的：

1. ✅ 功能完整性
2. ✅ 性能表现
3. ✅ 边界情况处理
4. ✅ 同步锁优化效果

---

## 二、测试前准备

### 2.1 环境准备

1. **浏览器环境**

   - Chrome/Edge 最新版本
   - 至少2台设备或2个浏览器配置文件

2. **账号准备**

   - 注册测试账号
   - 清空云端数据（从 Supabase 控制台）

3. **扩展安装**
   - 加载未打包的扩展
   - 打开开发者工具控制台
   - 启用详细日志

### 2.2 验证同步锁日志

打开扩展后，在控制台应该看到类似日志：

```
[SmartSync] 智能同步服务初始化，配置: {...}
[SmartSync] 自动同步已启动，间隔: 5 分钟
```

---

## 三、核心功能测试

### 测试1：本地操作触发同步

#### 测试用例1.1：创建标签组

**步骤**：

1. ✅ 登录账号
2. ✅ 在扩展中创建一个标签组
3. ✅ 等待10秒（5秒防抖 + 同步时间）
4. ✅ 检查控制台日志

**预期日志**：

```
[SmartSync] 检测到数据变化，触发同步...
[SmartSync] 开始上传到云端（同步锁已设置）
[SmartSync] 上传完成
[SmartSync] 上传操作完成，同步锁已释放
```

**验证**：

- ✅ 在另一台设备登录，刷新扩展
- ✅ 应该看到新创建的标签组

**通过标准**：

- 标签组成功同步到云端
- 日志显示同步锁正确设置和释放

---

#### 测试用例1.2：更新标签组

**步骤**：

1. ✅ 修改标签组名称
2. ✅ 等待10秒
3. ✅ 检查日志和云端数据

**预期**：同测试用例1.1

---

#### 测试用例1.3：删除标签组

**步骤**：

1. ✅ 删除一个标签组
2. ✅ 等待10秒
3. ✅ 验证云端同步

**预期**：同测试用例1.1

---

### 测试2：同步锁机制验证 ⭐

#### 测试用例2.1：云端下载不触发上传

**目的**：验证同步锁防止循环同步

**步骤**：

1. ✅ 在设备A创建标签组并同步
2. ✅ 在设备B登录（此时会从云端下载数据）
3. ✅ 观察设备B的控制台日志

**预期日志**：

```
[SmartSync] 开始从云端下载（同步锁已设置）
[SmartSync] 下载完成
[SmartSync] 正在同步中，跳过本次变化监听  ← 关键！
[SmartSync] 下载操作完成，同步锁已释放
```

**关键验证**：

- ✅ **必须**看到"正在同步中，跳过本次变化监听"
- ✅ **不应该**看到"开始上传到云端"

**通过标准**：

- 从云端下载后不会触发上传
- 同步锁正确防止循环同步

---

### 测试3：防抖机制

#### 测试用例3.1：快速连续操作

**步骤**：

1. ✅ 快速创建3个标签组（间隔<1秒）
2. ✅ 等待10秒
3. ✅ 检查日志

**预期**：

```
[SmartSync] 检测到数据变化，触发同步...
（只应该出现一次上传操作）
```

**通过标准**：

- 多次操作只触发一次同步
- 所有标签组都已上传

---

### 测试4：定时同步

#### 测试用例4.1：5分钟定时同步

**步骤**：

1. ✅ 登录后等待6分钟
2. ✅ 在本地创建标签组但**不手动同步**
3. ✅ 观察是否自动同步

**预期日志**：

```
[SmartSync] 定时自动同步触发...
（每5分钟出现一次）
```

**通过标准**：

- 每5分钟自动同步一次
- 本地数据自动上传

---

### 测试5：冲突解决

#### 测试用例5.1：newest 策略

**步骤**：

1. ✅ 设备A：创建标签组A（时间：T1）
2. ✅ 设备B（离线）：创建标签组B（时间：T2，T2 > T1）
3. ✅ 设备B 连网并同步
4. ✅ 设备A 同步

**预期**：

- 两台设备都看到标签组A和B
- 按创建时间倒序排列（B在前）

**通过标准**：

- 无数据丢失
- 排序正确

---

## 四、边界测试

### 测试6：网络异常

#### 测试用例6.1：断网后操作

**步骤**：

1. ✅ 断开网络连接
2. ✅ 创建标签组
3. ✅ 等待10秒
4. ✅ 重新连接网络
5. ✅ 等待30秒

**预期**：

- 断网时：同步失败但本地操作成功
- 重连后：自动重试并成功同步

**通过标准**：

- 本地数据不丢失
- 重连后自动同步

---

### 测试7：并发操作

#### 测试用例7.1：两设备同时创建

**步骤**：

1. ✅ 设备A和设备B同时创建不同的标签组
2. ✅ 等待30秒让两者同步
3. ✅ 验证两台设备的数据

**预期**：

- 两台设备都看到所有标签组
- 无数据丢失
- 无重复

---

### 测试8：大数据量

#### 测试用例8.1：100个标签组

**步骤**：

1. ✅ 导入100个标签组
2. ✅ 测量同步时间
3. ✅ 检查内存使用

**性能指标**：

- 同步时间：< 10秒
- 内存增长：< 50MB
- CPU使用：< 30%

---

## 五、回归测试

### 测试9：浏览器重启

**步骤**：

1. ✅ 登录并创建标签组
2. ✅ 完全关闭浏览器
3. ✅ 重新打开浏览器
4. ✅ 创建新标签组
5. ✅ 验证同步

**预期**：

- 浏览器重启后同步服务自动初始化
- 新标签组自动同步

---

### 测试10：登录/登出

**步骤**：

1. ✅ 登录 → 创建标签组 → 同步
2. ✅ 登出
3. ✅ 创建本地标签组
4. ✅ 重新登录

**预期**：

- 登出后不同步
- 重新登录后上传本地数据

---

## 六、性能测试

### 测试11：同步耗时

**方法**：
使用控制台计时：

```javascript
console.time('sync');
// 执行同步操作
console.timeEnd('sync');
```

**指标**：

- 上传10个标签组：< 2秒
- 下载10个标签组：< 2秒
- 完整同步（up+down）：< 5秒

---

### 测试12：内存使用

**方法**：

1. 打开 Chrome 任务管理器
2. 执行同步操作
3. 观察内存变化

**指标**：

- 同步前：~30MB
- 同步中：< 50MB
- 同步后：~35MB（允许小幅增长）

---

## 七、测试记录表

### 核心功能测试结果

| 测试用例           | 测试日期 | 执行人 | 结果 | 备注     |
| ------------------ | -------- | ------ | ---- | -------- |
| 1.1 创建标签组同步 |          |        | ⬜   |          |
| 1.2 更新标签组同步 |          |        | ⬜   |          |
| 1.3 删除标签组同步 |          |        | ⬜   |          |
| 2.1 同步锁验证 ⭐  |          |        | ⬜   | 最重要！ |
| 3.1 防抖机制       |          |        | ⬜   |          |
| 4.1 定时同步       |          |        | ⬜   |          |
| 5.1 冲突解决       |          |        | ⬜   |          |

### 边界测试结果

| 测试用例       | 测试日期 | 执行人 | 结果 | 备注 |
| -------------- | -------- | ------ | ---- | ---- |
| 6.1 断网后操作 |          |        | ⬜   |      |
| 7.1 并发操作   |          |        | ⬜   |      |
| 8.1 大数据量   |          |        | ⬜   |      |
| 9 浏览器重启   |          |        | ⬜   |      |
| 10 登录/登出   |          |        | ⬜   |      |

### 性能测试结果

| 测试项         | 目标   | 实际 | 通过 |
| -------------- | ------ | ---- | ---- |
| 上传10个标签组 | < 2s   |      | ⬜   |
| 下载10个标签组 | < 2s   |      | ⬜   |
| 完整同步       | < 5s   |      | ⬜   |
| 内存使用       | < 50MB |      | ⬜   |

---

## 八、问题记录

### 发现的问题

| 问题编号 | 描述 | 严重程度 | 状态 | 解决方案 |
| -------- | ---- | -------- | ---- | -------- |
|          |      |          |      |          |
|          |      |          |      |          |

### 改进建议

| 建议编号 | 描述 | 优先级 | 状态 |
| -------- | ---- | ------ | ---- |
|          |      |        |      |
|          |      |        |      |

---

## 九、测试总结

### 测试完成度

- [ ] 核心功能测试：0/7
- [ ] 边界测试：0/5
- [ ] 性能测试：0/4
- [ ] 回归测试：0/2

**总计**：0/18 (0%)

### 关键发现

（待测试完成后填写）

### 通过标准

测试通过需满足：

1. ✅ 所有核心功能测试通过
2. ✅ 同步锁机制验证通过（最重要）
3. ✅ 至少80%边界测试通过
4. ✅ 性能指标达标
5. ✅ 无P0/P1级别bug

---

## 十、快速验证脚本（开发者工具）

### 验证同步锁是否生效

在控制台运行：

```javascript
// 1. 监听日志
console.log('开始监听同步日志...');

// 2. 手动触发下载（模拟从云端下载）
// 注意：需要在扩展的 background context 中执行
chrome.runtime.sendMessage({ type: 'DOWNLOAD_FROM_CLOUD' });

// 3. 等待3秒后检查日志
setTimeout(() => {
  console.log('检查日志，应该看到：');
  console.log('- [SmartSync] 开始从云端下载（同步锁已设置）');
  console.log('- [SmartSync] 正在同步中，跳过本次变化监听');
  console.log('- [SmartSync] 下载操作完成，同步锁已释放');
}, 3000);
```

### 验证防抖机制

```javascript
// 快速创建多个标签组
for (let i = 0; i < 3; i++) {
  chrome.runtime.sendMessage({
    type: 'CREATE_TAB_GROUP',
    name: `测试组 ${i}`,
  });
}

// 等待10秒后检查日志
// 应该只看到一次上传操作
```

---

**文档版本**：1.0.0  
**最后更新**：2025-10-09  
**维护人**：开发团队
